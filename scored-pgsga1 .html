<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG-SGA ç‡Ÿé¤Šè©•ä¼°å•å·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.2em; margin: 0 0 10px 0; }
        .tabs {
            display: flex;
            background: #f8f9fa;
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .tab-button.active { background: white; color: #4a90e2; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #4a90e2;
        }
        .section h3 { color: #2c3e50; margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 8px; margin: 10px 0; }
        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
        }
        .radio-item:hover, .checkbox-item:hover { border-color: #4a90e2; }
        .radio-item input, .checkbox-item input { margin-right: 10px; }
        .score { 
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #4a90e2; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn:hover { opacity: 0.9; }
        .total-score {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 15px 0;
        }
        .record { border: 1px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 8px; }
        .record-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ PG-SGA ç‡Ÿé¤Šè©•ä¼°ç³»çµ±</h1>
            <p>Patient-Generated Subjective Global Assessment</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('survey')">ğŸ“ å¡«å¯«å•å·</button>
            <button class="tab-button" onclick="switchTab('records')">ğŸ“Š æŸ¥çœ‹è¨˜éŒ„</button>
            <button class="tab-button" onclick="switchTab('export')">ğŸ’¾ åŒ¯å‡ºè³‡æ–™</button>
        </div>

        <!-- å•å·é é¢ -->
        <div id="survey" class="tab-content active">
            <form id="pgsga-form">
                <div class="section">
                    <h3>åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è©•ä¼°æ—¥æœŸ:</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>å§“å:</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label>ç—…æ­·è™Ÿ:</label>
                            <input type="text" id="number" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¹´é½¡:</label>
                            <input type="number" id="age" required>
                        </div>
                        <div class="form-group">
                            <label>æ€§åˆ¥:</label>
                            <select id="gender" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="male">ç”·</option>
                                <option value="female">å¥³</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><strong>æ²»ç™‚æ–¹å¼:</strong></label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                            <div class="checkbox-item" style="flex: none;">
                                <input type="checkbox" name="treatment" value="surgery" id="surgery">
                                <label for="surgery">æ‰‹è¡“</label>
                            </div>
                            <div class="checkbox-item" style="flex: none;">
                                <input type="checkbox" name="treatment" value="radiation" id="radiation">
                                <label for="radiation">æ”¾ç™‚</label>
                            </div>
                            <div class="checkbox-item" style="flex: none;">
                                <input type="checkbox" name="treatment" value="chemotherapy" id="chemotherapy">
                                <label for="chemotherapy">åŒ–ç™‚</label>
                            </div>
                            <div class="checkbox-item" style="flex: none;">
                                <input type="checkbox" name="treatment" value="other" id="other_treatment">
                                <label for="other_treatment">å…¶ä»–</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>A1. é«”é‡è®ŠåŒ–</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç›®å‰é«”é‡ (kg):</label>
                            <input type="number" id="currentWeight" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>èº«é«˜ (cm):</label>
                            <input type="number" id="height" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>ä¸€å€‹æœˆå‰é«”é‡ (kg):</label>
                            <input type="number" id="oneMonthWeight" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>å…­å€‹æœˆå‰é«”é‡ (kg):</label>
                            <input type="number" id="sixMonthWeight" step="0.1">
                        </div>
                    </div>
                    
                    <label><strong>å…©å€‹æ˜ŸæœŸå‰é«”é‡è®ŠåŒ–:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="1" id="acute1">
                            <label for="acute1">é™ä½ (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="0" id="acute0">
                            <label for="acute0">æ²’æœ‰æ”¹è®Š (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="0" id="acute_inc">
                            <label for="acute_inc">å¢åŠ  (0åˆ†)</label>
                        </div>
                    </div>

                    <label><strong>é«”é‡è®ŠåŒ–ç¨‹åº¦:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="4" id="sub4">
                            <label for="sub4">â‰¥10%/1å€‹æœˆ (â‰¥20%/6å€‹æœˆ) - 4åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="3" id="sub3">
                            <label for="sub3">5-9.9%/1å€‹æœˆ (10%-19.9%/6å€‹æœˆ) - 3åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="2" id="sub2">
                            <label for="sub2">3-4.9%/1å€‹æœˆ (6-9.9%/6å€‹æœˆ) - 2åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="1" id="sub1">
                            <label for="sub1">2-2.9%/1å€‹æœˆ (2-5.9%/6å€‹æœˆ) - 1åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="0" id="sub0">
                            <label for="sub0">0-1.9%/1å€‹æœˆ (0-1.9%/6å€‹æœˆ) - 0åˆ†</label>
                        </div>
                    </div>
                    <div class="score" id="A1-score">A1 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>A2. æ”é£Ÿæƒ…æ³</h3>
                    <label><strong>æœ€è¿‘æ”é£Ÿé‡èˆ‡å¹³å¸¸æ¯”è¼ƒ:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="0" id="intake_same">
                            <label for="intake_same">æ²’æ”¹è®Š (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="0" id="intake_more">
                            <label for="intake_more">å¤š (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="1" id="intake_less">
                            <label for="intake_less">å°‘ (1åˆ†)</label>
                        </div>
                    </div>

                    <label><strong>ç›®å‰æ”é£Ÿç‹€æ³:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="1" id="normal_less">
                            <label for="normal_less">æ­£å¸¸é£²é£Ÿä½†è¼ƒå°‘ (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="2" id="little_solid">
                            <label for="little_solid">å°‘è¨±å›ºé«”é£Ÿç‰© (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="3" id="liquid_food">
                            <label for="liquid_food">æ¶²é«”é£Ÿç‰© (3åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="3" id="supplements">
                            <label for="supplements">ç‡Ÿé¤Šè£œå……å“ (3åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="4" id="very_little">
                            <label for="very_little">éå¸¸å°‘ (4åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="0" id="tube_iv">
                            <label for="tube_iv">åƒ…é ç®¡çŒæˆ–éœè„ˆç‡Ÿé¤Š (0åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="A2-score">A2 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>A3. è…¸èƒƒç—‡ç‹€</h3>
                    <label><strong>å½±éŸ¿è¿‘å…©é€±æ”é£Ÿçš„ç—‡ç‹€:</strong></label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="0" id="no_problem">
                            <label for="no_problem">æ²’æœ‰å•é¡Œ (0åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="no_appetite">
                            <label for="no_appetite">æ²’é£Ÿæ…¾ (3åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="nausea">
                            <label for="nausea">å™å¿ƒ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="vomiting">
                            <label for="vomiting">å˜”å (3åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="constipation">
                            <label for="constipation">ä¾¿ç§˜ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="diarrhea">
                            <label for="diarrhea">è…¹ç€‰ (3åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="2" id="mouth_pain">
                            <label for="mouth_pain">å£ç—› (2åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="dry_mouth">
                            <label for="dry_mouth">å£ä¹¾ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="smell_problem">
                            <label for="smell_problem">å—…è¦ºå›°æ“¾ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="no_interest">
                            <label for="no_interest">æ²’èˆˆè¶£ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="swallow_difficulty">
                            <label for="swallow_difficulty">ååš¥å›°é›£ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="early_satiety">
                            <label for="early_satiety">æ˜“é£½è„¹ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="pain">
                            <label for="pain">ç–¼ç—› (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="other_symptoms">
                            <label for="other_symptoms">å…¶ä»– (1åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="A3-score">A3 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>A4. èº«é«”æ´»å‹•ç‹€æ³</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="0" id="normal_activity">
                            <label for="normal_activity">æ­£å¸¸ (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="1" id="mild_limited">
                            <label for="mild_limited">è¼•å¾®å—é™ä½†èƒ½è‡ªç† (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="2" id="severe_limited">
                            <label for="severe_limited">åš´é‡å—é™ä½†è‡¥åºŠä¸è¶…éåŠå¤© (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="3" id="bedridden">
                            <label for="bedridden">é•·æ™‚é–“è‡¥åºŠ (3åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="A4-score">A4 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>B. ç–¾ç—…ç›¸é—œ</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="cancer">
                            <label for="cancer">ç™Œç—‡ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="aids">
                            <label for="aids">å¾Œå¤©å…ç–«ä¸å…¨ç—‡å€™ç¾¤ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="pressure_ulcer">
                            <label for="pressure_ulcer">è¤¥ç˜¡ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="trauma">
                            <label for="trauma">å‰µå‚· (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="elderly">
                            <label for="elderly">65æ­²ä»¥ä¸Š (1åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="B-score">B å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>C. ä»£è¬å£“åŠ›</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="0" id="no_stress">
                            <label for="no_stress">æ²’æœ‰ç™¼ç‡’ã€ç„¡é¡å›ºé†‡ã€ç„¡å£“åŠ› (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="1" id="low_stress">
                            <label for="low_stress">&lt;38â„ƒã€ç™¼ç‡’æ™‚æ•¸&lt;72hã€é¡å›ºé†‡&lt;10mg prednisone/d ä½åº¦å£“åŠ› (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="2" id="moderate_stress">
                            <label for="moderate_stress">38ã€œ38.8â„ƒã€ç™¼ç‡’æ™‚æ•¸72hã€é¡å›ºé†‡10ã€œ30mg prednisone/d ä¸­åº¦å£“åŠ› (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="3" id="high_stress">
                            <label for="high_stress">&gt;38.8â„ƒã€ç™¼ç‡’æ™‚&gt;72hã€é¡å›ºé†‡&gt;30mg prednisone/d é«˜åº¦å£“åŠ› (3åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="C-score">C å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>D. èº«é«”æª¢æŸ¥</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="0" id="no_deficit">
                            <label for="no_deficit">æ²’ç¼ºä¹ (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="1" id="mild_deficit">
                            <label for="mild_deficit">è¼•åº¦ç¼ºä¹ (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="2" id="moderate_deficit">
                            <label for="moderate_deficit">ä¸­åº¦ç¼ºä¹ (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="3" id="severe_deficit">
                            <label for="severe_deficit">é‡åº¦ç¼ºä¹ (3åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="D-score">D å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <div class="total-score" id="totalScore">ç¸½åˆ†: 0</div>
                    <div class="score" id="advice" style="background: #17a2b8;">å»ºè­°æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button type="submit" class="btn btn-success">ğŸ’¾ å„²å­˜å•å·</button>
                    <button type="button" class="btn btn-warning" onclick="resetForm()">ğŸ”„ é‡è¨­</button>
                </div>
            </form>
        </div>

        <!-- æŸ¥çœ‹è¨˜éŒ„é é¢ -->
        <div id="records" class="tab-content">
            <div class="section">
                <h3>ğŸ“Š å•å·è¨˜éŒ„</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="loadRecords()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    <button class="btn btn-warning" onclick="clearRecords()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
                </div>
                <div id="recordsList"></div>
            </div>
        </div>

        <!-- åŒ¯å‡ºè³‡æ–™é é¢ -->
        <div id="export" class="tab-content">
            <div class="section">
                <h3>ğŸ’¾ è³‡æ–™åŒ¯å‡º</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="exportJSON()">ğŸ“„ JSON</button>
                    <button class="btn btn-primary" onclick="exportCSV()">ğŸ“Š CSV</button>
                    <button class="btn btn-warning" onclick="exportHTML()">ğŸŒ HTML</button>
                </div>
                <div id="exportResult"></div>
            </div>
        </div>
    </div>

    <script>
        let records = [];

        function loadRecords() {
            try {
                const stored = localStorage.getItem('pgsga_records');
                records = stored ? JSON.parse(stored) : [];
            } catch (e) {
                records = [];
            }
        }

        function saveRecords() {
            localStorage.setItem('pgsga_records', JSON.stringify(records));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'records') showRecords();
        }

        function updateScores() {
            const acute = parseInt(document.querySelector('input[name="acuteWeight"]:checked')?.value || 0);
            const subAcute = parseInt(document.querySelector('input[name="subAcuteWeight"]:checked')?.value || 0);
            const a1 = acute + subAcute;
            document.getElementById('A1-score').textContent = `A1 å¾—åˆ†: ${a1}`;

            const intake1 = parseInt(document.querySelector('input[name="intakeComparison"]:checked')?.value || 0);
            const intake2 = parseInt(document.querySelector('input[name="currentIntake"]:checked')?.value || 0);
            const a2 = Math.max(intake1, intake2);
            document.getElementById('A2-score').textContent = `A2 å¾—åˆ†: ${a2}`;

            const symptoms = document.querySelectorAll('input[name="symptoms"]:checked');
            const a3 = Array.from(symptoms).reduce((sum, s) => sum + parseInt(s.value), 0);
            document.getElementById('A3-score').textContent = `A3 å¾—åˆ†: ${a3}`;

            const a4 = parseInt(document.querySelector('input[name="activityStatus"]:checked')?.value || 0);
            document.getElementById('A4-score').textContent = `A4 å¾—åˆ†: ${a4}`;

            const diseases = document.querySelectorAll('input[name="diseaseRelated"]:checked');
            const b = Array.from(diseases).reduce((sum, d) => sum + parseInt(d.value), 0);
            document.getElementById('B-score').textContent = `B å¾—åˆ†: ${b}`;

            const c = parseInt(document.querySelector('input[name="metabolicStress"]:checked')?.value || 0);
            document.getElementById('C-score').textContent = `C å¾—åˆ†: ${c}`;

            const d = parseInt(document.querySelector('input[name="physicalExam"]:checked')?.value || 0);
            document.getElementById('D-score').textContent = `D å¾—åˆ†: ${d}`;

            const total = a1 + a2 + a3 + a4 + b + c + d;
            document.getElementById('totalScore').textContent = `ç¸½åˆ†: ${total}`;

            let advice = '';
            if (total >= 9) advice = 'ğŸš¨ åš´é‡ç‡Ÿé¤Šä¸è‰¯é¢¨éšª - å»ºè­°ç«‹å³ç‡Ÿé¤Šä»‹å…¥';
            else if (total >= 4) advice = 'âš ï¸ ä¸­åº¦ç‡Ÿé¤Šä¸è‰¯é¢¨éšª - å»ºè­°ç‡Ÿé¤Šè©•ä¼°';
            else advice = 'âœ… ç‡Ÿé¤Šç‹€æ³è‰¯å¥½ - æŒçºŒç›£æ¸¬';
            document.getElementById('advice').textContent = advice;

            return { a1, a2, a3, a4, b, c, d, total, advice };
        }

        function collectData() {
            const getSelected = (name) => {
                const el = document.querySelector(`input[name="${name}"]:checked`);
                return el ? { value: el.value, text: el.nextElementSibling.textContent } : null;
            };

            const getMultiSelected = (name) => {
                const els = document.querySelectorAll(`input[name="${name}"]:checked`);
                return Array.from(els).map(el => ({
                    value: el.value,
                    text: el.nextElementSibling.textContent
                }));
            };

            const treatments = getMultiSelected('treatment');
            const treatmentMap = { surgery: 'æ‰‹è¡“', radiation: 'æ”¾ç™‚', chemotherapy: 'åŒ–ç™‚', other: 'å…¶ä»–' };

            return {
                date: document.getElementById('date').value,
                name: document.getElementById('name').value,
                number: document.getElementById('number').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                treatment: treatments.map(t => t.value),
                treatmentText: treatments.map(t => treatmentMap[t.value] || t.value).join(', '),
                currentWeight: document.getElementById('currentWeight').value,
                height: document.getElementById('height').value,
                oneMonthWeight: document.getElementById('oneMonthWeight').value,
                sixMonthWeight: document.getElementById('sixMonthWeight').value,
                acuteWeight: getSelected('acuteWeight'),
                subAcuteWeight: getSelected('subAcuteWeight'),
                intakeComparison: getSelected('intakeComparison'),
                currentIntake: getSelected('currentIntake'),
                symptoms: getMultiSelected('symptoms'),
                activityStatus: getSelected('activityStatus'),
                diseaseRelated: getMultiSelected('diseaseRelated'),
                metabolicStress: getSelected('metabolicStress'),
                physicalExam: getSelected('physicalExam'),
                scores: updateScores(),
                timestamp: new Date().toISOString()
            };
        }

        function resetForm() {
            if (confirm('ç¢ºå®šè¦é‡è¨­å—ï¼Ÿ')) {
                document.getElementById('pgsga-form').reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                updateScores();
            }
        }

        function showRecords() {
            const list = document.getElementById('recordsList');
            if (records.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            list.innerHTML = records.map((record, index) => `
                <div class="record">
                    <div class="record-header">
                        <h4>${record.name} (${record.number}) - ${new Date(record.date).toLocaleDateString()}</h4>
                        <button class="btn btn-warning" onclick="deleteRecord(${index})">åˆªé™¤</button>
                    </div>
                    <p><strong>åŸºæœ¬:</strong> ${record.age}æ­² ${record.gender === 'male' ? 'ç”·' : 'å¥³'} | èº«é«˜:${record.height}cm é«”é‡:${record.currentWeight}kg</p>
                    <p><strong>æ²»ç™‚:</strong> ${record.treatmentText || 'æœªå¡«'}</p>
                    <p><strong>åˆ†æ•¸:</strong> A1:${record.scores.a1} A2:${record.scores.a2} A3:${record.scores.a3} A4:${record.scores.a4} B:${record.scores.b} C:${record.scores.c} D:${record.scores.d}</p>
                    <p><strong>ç¸½åˆ†:</strong> ${record.scores.total} - ${record.scores.advice}</p>
                </div>
            `).join('');
        }

        function deleteRecord(index) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                records.splice(index, 1);
                saveRecords();
                showRecords();
            }
        }

        function clearRecords() {
            if (confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼Ÿ')) {
                records = [];
                saveRecords();
                showRecords();
            }
        }

        function exportJSON() {
            if (records.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            const data = JSON.stringify(records, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = 'âœ… JSONå·²ä¸‹è¼‰';
        }

        function exportCSV() {
            if (records.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const headers = ['æ—¥æœŸ', 'å§“å', 'ç—…æ­·è™Ÿ', 'å¹´é½¡', 'æ€§åˆ¥', 'æ²»ç™‚æ–¹å¼', 'èº«é«˜', 'é«”é‡', 'A1åˆ†æ•¸', 'A2åˆ†æ•¸', 'A3åˆ†æ•¸', 'A4åˆ†æ•¸', 'Båˆ†æ•¸', 'Cåˆ†æ•¸', 'Dåˆ†æ•¸', 'ç¸½åˆ†', 'å»ºè­°'];
            
            const csvData = [
                headers.join(','),
                ...records.map(r => [
                    r.date,
                    `"${r.name}"`,
                    r.number,
                    r.age,
                    r.gender === 'male' ? 'ç”·' : 'å¥³',
                    `"${r.treatmentText || ''}"`,
                    r.height,
                    r.currentWeight,
                    r.scores.a1,
                    r.scores.a2,
                    r.scores.a3,
                    r.scores.a4,
                    r.scores.b,
                    r.scores.c,
                    r.scores.d,
                    r.scores.total,
                    `"${r.scores.advice}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvData], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = 'âœ… CSVå·²ä¸‹è¼‰';
        }

        function exportHTML() {
            if (records.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const html = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>PG-SGAè©•ä¼°å ±å‘Š</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .record { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 8px; }
        .record h3 { background: #f5f5f5; padding: 10px; margin: -15px -15px 15px -15px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f5f5f5; }
    </style>
</head>
<body>
    <div class="header">
        <h1>PG-SGA ç‡Ÿé¤Šè©•ä¼°å ±å‘Š</h1>
        <p>ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
    </div>
    
    ${records.map((r, i) => `
        <div class="record">
            <h3>è¨˜éŒ„ ${i + 1}: ${r.name} (${r.number}) - ${new Date(r.date).toLocaleDateString('zh-TW')}</h3>
            <table>
                <tr><th>é …ç›®</th><th>å…§å®¹</th></tr>
                <tr><td>åŸºæœ¬è³‡æ–™</td><td>å¹´é½¡: ${r.age}æ­², æ€§åˆ¥: ${r.gender === 'male' ? 'ç”·' : 'å¥³'}</td></tr>
                <tr><td>æ²»ç™‚æ–¹å¼</td><td>${r.treatmentText || 'æœªå¡«'}</td></tr>
                <tr><td>èº«é«”æ¸¬é‡</td><td>èº«é«˜: ${r.height}cm, é«”é‡: ${r.currentWeight}kg</td></tr>
                <tr><td>å„é …åˆ†æ•¸</td><td>A1:${r.scores.a1} A2:${r.scores.a2} A3:${r.scores.a3} A4:${r.scores.a4} B:${r.scores.b} C:${r.scores.c} D:${r.scores.d}</td></tr>
                <tr><td><strong>ç¸½åˆ†</strong></td><td><strong>${r.scores.total}</strong></td></tr>
                <tr><td>å»ºè­°</td><td>${r.scores.advice}</td></tr>
            </table>
        </div>
    `).join('')}
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_report_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = 'âœ… HTMLå ±å‘Šå·²ä¸‹è¼‰';
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', updateScores);
            });

            document.getElementById('pgsga-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const data = collectData();
                if (!data.name || !data.number || !data.age) {
                    alert('è«‹å¡«å¯«å¿…è¦è³‡æ–™');
                    return;
                }
                
                records.push(data);
                saveRecords();
                alert('å·²å„²å­˜ï¼');
                switchTab('records');
            });
            
            updateScores();
        });
    </script>
</body>
</html>
