<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG-SGA 營養評估問卷</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.2em; margin: 0 0 10px 0; }
        .tabs {
            display: flex;
            background: #f8f9fa;
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .tab-button.active { background: white; color: #4a90e2; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #4a90e2;
        }
        .section h3 { color: #2c3e50; margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 8px; margin: 10px 0; }
        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
        }
        .radio-item:hover, .checkbox-item:hover { border-color: #4a90e2; }
        .radio-item input, .checkbox-item input { margin-right: 10px; }
        .score { 
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #4a90e2; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn:hover { opacity: 0.9; }
        .total-score {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 15px 0;
        }
        .record { border: 1px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 8px; }
        .record-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 PG-SGA 營養評估系統</h1>
            <p>Patient-Generated Subjective Global Assessment</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('survey')">📝 填寫問卷</button>
            <button class="tab-button" onclick="switchTab('records')">📊 查看記錄</button>
            <button class="tab-button" onclick="switchTab('export')">💾 匯出資料</button>
        </div>

        <!-- 問卷頁面 -->
        <div id="survey" class="tab-content active">
            <form id="pgsga-form">
                <div class="section">
                    <h3>基本資料</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>評估日期:</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>姓名:</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label>病歷號:</label>
                            <input type="text" id="number" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>年齡:</label>
                            <input type="number" id="age" required>
                        </div>
                        <div class="form-group">
                            <label>性別:</label>
                            <select id="gender" required>
                                <option value="">請選擇</option>
                                <option value="male">男</option>
                                <option value="female">女</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>A1. 體重變化</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>目前體重 (kg):</label>
                            <input type="number" id="currentWeight" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>身高 (cm):</label>
                            <input type="number" id="height" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>一個月前體重 (kg):</label>
                            <input type="number" id="oneMonthWeight" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>六個月前體重 (kg):</label>
                            <input type="number" id="sixMonthWeight" step="0.1">
                        </div>
                    </div>
                    
                    <label><strong>兩個星期前體重變化:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="1" id="acute1">
                            <label for="acute1">降低 (1分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="0" id="acute0">
                            <label for="acute0">沒有改變 (0分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="0" id="acute_inc">
                            <label for="acute_inc">增加 (0分)</label>
                        </div>
                    </div>

                    <label><strong>體重變化程度:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="4" id="sub4">
                            <label for="sub4">≥10%/1個月 (≥20%/6個月) - 4分</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="3" id="sub3">
                            <label for="sub3">5-9.9%/1個月 (10%-19.9%/6個月) - 3分</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="2" id="sub2">
                            <label for="sub2">3-4.9%/1個月 (6-9.9%/6個月) - 2分</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="1" id="sub1">
                            <label for="sub1">2-2.9%/1個月 (2-5.9%/6個月) - 1分</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="0" id="sub0">
                            <label for="sub0">0-1.9%/1個月 (0-1.9%/6個月) - 0分</label>
                        </div>
                    </div>
                    <div class="score" id="A1-score">A1 得分: 0</div>
                </div>

                <div class="section">
                    <h3>A2. 攝食情況</h3>
                    <label><strong>最近攝食量與平常比較:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="0" id="intake_same">
                            <label for="intake_same">沒改變 (0分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="0" id="intake_more">
                            <label for="intake_more">多 (0分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="1" id="intake_less">
                            <label for="intake_less">少 (1分)</label>
                        </div>
                    </div>

                    <label><strong>目前攝食狀況:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="1" id="normal_less">
                            <label for="normal_less">正常飲食但較少 (1分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="2" id="little_solid">
                            <label for="little_solid">少許固體食物 (2分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="3" id="liquid_food">
                            <label for="liquid_food">液體食物 (3分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="3" id="supplements">
                            <label for="supplements">營養補充品 (3分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="4" id="very_little">
                            <label for="very_little">非常少 (4分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="0" id="tube_iv">
                            <label for="tube_iv">僅靠管灌或靜脈營養 (0分)</label>
                        </div>
                    </div>
                    <div class="score" id="A2-score">A2 得分: 0</div>
                </div>

                <div class="section">
                    <h3>A3. 腸胃症狀</h3>
                    <label><strong>影響近兩週攝食的症狀:</strong></label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="0" id="no_problem">
                            <label for="no_problem">沒有問題 (0分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="no_appetite">
                            <label for="no_appetite">沒食慾 (3分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="nausea">
                            <label for="nausea">噁心 (1分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="vomiting">
                            <label for="vomiting">嘔吐 (3分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="constipation">
                            <label for="constipation">便秘 (1分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="diarrhea">
                            <label for="diarrhea">腹瀉 (3分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="2" id="mouth_pain">
                            <label for="mouth_pain">口痛 (2分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="dry_mouth">
                            <label for="dry_mouth">口乾 (1分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="other_symptoms">
                            <label for="other_symptoms">其他 (1分)</label>
                        </div>
                    </div>
                    <div class="score" id="A3-score">A3 得分: 0</div>
                </div>

                <div class="section">
                    <h3>A4. 身體活動狀況</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="0" id="normal_activity">
                            <label for="normal_activity">正常 (0分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="1" id="mild_limited">
                            <label for="mild_limited">輕微受限但能自理 (1分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="2" id="severe_limited">
                            <label for="severe_limited">嚴重受限但臥床不超過半天 (2分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="3" id="bedridden">
                            <label for="bedridden">長時間臥床 (3分)</label>
                        </div>
                    </div>
                    <div class="score" id="A4-score">A4 得分: 0</div>
                </div>

                <div class="section">
                    <h3>B. 疾病相關</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="cancer">
                            <label for="cancer">癌症 (1分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="aids">
                            <label for="aids">免疫缺陷 (1分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="pressure_ulcer">
                            <label for="pressure_ulcer">褥瘡 (1分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="trauma">
                            <label for="trauma">創傷 (1分)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="elderly">
                            <label for="elderly">65歲以上 (1分)</label>
                        </div>
                    </div>
                    <div class="score" id="B-score">B 得分: 0</div>
                </div>

                <div class="section">
                    <h3>C. 代謝壓力</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="0" id="no_stress">
                            <label for="no_stress">沒有發燒、無類固醇、無壓力 (0分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="1" id="low_stress">
                            <label for="low_stress">&lt;38℃、發燒時數&lt;72h、類固醇&lt;10mg prednisone/d 低度壓力 (1分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="2" id="moderate_stress">
                            <label for="moderate_stress">38〜38.8℃、發燒時數72h、類固醇10〜30mg prednisone/d 中度壓力 (2分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="3" id="high_stress">
                            <label for="high_stress">&gt;38.8℃、發燒時&gt;72h、類固醇&gt;30mg prednisone/d 高度壓力 (3分)</label>
                        </div>
                    </div>
                    <div class="score" id="C-score">C 得分: 0</div>
                </div>

                <div class="section">
                    <h3>D. 身體檢查</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="0" id="no_deficit">
                            <label for="no_deficit">沒缺乏 (0分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="1" id="mild_deficit">
                            <label for="mild_deficit">輕度缺乏 (1分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="2" id="moderate_deficit">
                            <label for="moderate_deficit">中度缺乏 (2分)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="3" id="severe_deficit">
                            <label for="severe_deficit">重度缺乏 (3分)</label>
                        </div>
                    </div>
                    <div class="score" id="D-score">D 得分: 0</div>
                </div>

                <div class="section">
                    <div class="total-score" id="totalScore">總分: 0</div>
                    <div class="score" id="advice" style="background: #17a2b8;">建議會顯示在這裡</div>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button type="submit" class="btn btn-success">💾 儲存問卷</button>
                    <button type="button" class="btn btn-warning" onclick="resetForm()">🔄 重設</button>
                </div>
            </form>
        </div>

        <!-- 查看記錄頁面 -->
        <div id="records" class="tab-content">
            <div class="section">
                <h3>📊 問卷記錄</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="loadRecords(); showRecords();">🔄 重新載入</button>
                    <button class="btn btn-warning" onclick="clearRecords()">🗑️ 清除記錄</button>
                </div>
                <div id="recordsList"></div>
            </div>
        </div>

        <!-- 匯出資料頁面 -->
        <div id="export" class="tab-content">
            <div class="section">
                <h3>💾 資料匯出</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="exportJSON()">📄 JSON</button>
                    <button class="btn btn-primary" onclick="exportCSV()">📊 CSV</button>
                    <button class="btn btn-warning" onclick="exportHTML()">🌐 HTML</button>
                </div>
                <div id="exportResult"></div>
            </div>
        </div>
    </div>

    <script>
        let records = [];

        // 載入記錄
        function loadRecords() {
            try {
                const stored = localStorage.getItem('pgsga_records');
                records = stored ? JSON.parse(stored) : [];
            } catch (e) {
                records = [];
            }
        }

        // 儲存記錄
        function saveRecords() {
            localStorage.setItem('pgsga_records', JSON.stringify(records));
        }

        // 切換標籤頁
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'records') showRecords();
        }

        // 更新分數
        function updateScores() {
            // A1
            const acute = parseInt(document.querySelector('input[name="acuteWeight"]:checked')?.value || 0);
            const subAcute = parseInt(document.querySelector('input[name="subAcuteWeight"]:checked')?.value || 0);
            const a1 = acute + subAcute;
            document.getElementById('A1-score').textContent = `A1 得分: ${a1}`;

            // A2
            const intake1 = parseInt(document.querySelector('input[name="intakeComparison"]:checked')?.value || 0);
            const intake2 = parseInt(document.querySelector('input[name="currentIntake"]:checked')?.value || 0);
            const a2 = Math.max(intake1, intake2);
            document.getElementById('A2-score').textContent = `A2 得分: ${a2}`;

            // A3
            const symptoms = document.querySelectorAll('input[name="symptoms"]:checked');
            const a3 = Array.from(symptoms).reduce((sum, s) => sum + parseInt(s.value), 0);
            document.getElementById('A3-score').textContent = `A3 得分: ${a3}`;

            // A4
            const a4 = parseInt(document.querySelector('input[name="activityStatus"]:checked')?.value || 0);
            document.getElementById('A4-score').textContent = `A4 得分: ${a4}`;

            // B
            const diseases = document.querySelectorAll('input[name="diseaseRelated"]:checked');
            const b = Array.from(diseases).reduce((sum, d) => sum + parseInt(d.value), 0);
            document.getElementById('B-score').textContent = `B 得分: ${b}`;

            // C
            const c = parseInt(document.querySelector('input[name="metabolicStress"]:checked')?.value || 0);
            document.getElementById('C-score').textContent = `C 得分: ${c}`;

            // D
            const d = parseInt(document.querySelector('input[name="physicalExam"]:checked')?.value || 0);
            document.getElementById('D-score').textContent = `D 得分: ${d}`;

            // 總分
            const total = a1 + a2 + a3 + a4 + b + c + d;
            document.getElementById('totalScore').textContent = `總分: ${total}`;

            // 建議
            let advice = '';
            if (total >= 9) advice = '🚨 嚴重營養不良風險';
            else if (total >= 4) advice = '⚠️ 中度營養不良風險';
            else advice = '✅ 營養狀況良好';
            document.getElementById('advice').textContent = advice;

            return { a1, a2, a3, a4, b, c, d, total, advice };
        }

        // 收集表單資料
        function collectData() {
            const getSelected = (name) => {
                const el = document.querySelector(`input[name="${name}"]:checked`);
                return el ? { value: el.value, text: el.nextElementSibling.textContent.trim() } : null;
            };

            const getMultiSelected = (name) => {
                const els = document.querySelectorAll(`input[name="${name}"]:checked`);
                return Array.from(els).map(el => ({
                    value: el.value,
                    text: el.nextElementSibling.textContent.trim()
                }));
            };

            return {
                date: document.getElementById('date').value,
                name: document.getElementById('name').value,
                number: document.getElementById('number').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                currentWeight: document.getElementById('currentWeight').value,
                height: document.getElementById('height').value,
                oneMonthWeight: document.getElementById('oneMonthWeight').value,
                sixMonthWeight: document.getElementById('sixMonthWeight').value,
                acuteWeight: getSelected('acuteWeight'),
                subAcuteWeight: getSelected('subAcuteWeight'),
                intakeComparison: getSelected('intakeComparison'),
                currentIntake: getSelected('currentIntake'),
                symptoms: getMultiSelected('symptoms'),
                activityStatus: getSelected('activityStatus'),
                diseaseRelated: getMultiSelected('diseaseRelated'),
                metabolicStress: getSelected('metabolicStress'),
                physicalExam: getSelected('physicalExam'),
                scores: updateScores(),
                timestamp: new Date().toISOString()
            };
        }

        // Helper: 把選項物件/陣列轉成可顯示文字
        function selText(sel) {
            if (!sel) return '';
            if (Array.isArray(sel)) return sel.map(s => s.text).join('； ');
            return sel.text || '';
        }

        // 重設表單
        function resetForm() {
            if (confirm('確定要重設嗎？')) {
                document.getElementById('pgsga-form').reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                updateScores();
            }
        }

        // 顯示記錄（已擴充：顯示使用者當時選擇的項目）
        function showRecords() {
            const list = document.getElementById('recordsList');
            if (records.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">尚無記錄</p>';
                return;
            }

            list.innerHTML = records.map((record, index) => `
                <div class="record">
                    <div class="record-header">
                        <h4>${record.name} (${record.number}) - ${new Date(record.date).toLocaleDateString()}</h4>
                        <button class="btn btn-warning" onclick="deleteRecord(${index})">刪除</button>
                    </div>
                    <p><strong>基本:</strong> ${record.age}歲 ${record.gender === 'male' ? '男' : '女'} | 身高:${record.height}cm 體重:${record.currentWeight}kg</p>
                    <p><strong>分數:</strong> A1:${record.scores.a1} A2:${record.scores.a2} A3:${record.scores.a3} A4:${record.scores.a4} B:${record.scores.b} C:${record.scores.c} D:${record.scores.d}</p>
                    <p><strong>總分:</strong> ${record.scores.total} - ${record.scores.advice}</p>
                    <details>
                        <summary style="cursor: pointer;">▶ 當時所選擇的項目 (點開查看)</summary>
                        <ul>
                            <li><strong>兩週體重變化:</strong> ${selText(record.acuteWeight)}</li>
                            <li><strong>體重變化程度:</strong> ${selText(record.subAcuteWeight)}</li>
                            <li><strong>最近攝食量與平常比較:</strong> ${selText(record.intakeComparison)}</li>
                            <li><strong>目前攝食狀況:</strong> ${selText(record.currentIntake)}</li>
                            <li><strong>腸胃症狀:</strong> ${selText(record.symptoms)}</li>
                            <li><strong>身體活動狀況:</strong> ${selText(record.activityStatus)}</li>
                            <li><strong>疾病相關:</strong> ${selText(record.diseaseRelated)}</li>
                            <li><strong>代謝壓力:</strong> ${selText(record.metabolicStress)}</li>
                            <li><strong>身體檢查:</strong> ${selText(record.physicalExam)}</li>
                        </ul>
                    </details>
                </div>
            `).join('');
        }

        // 刪除單筆記錄
        function deleteRecord(i) {
            if (!confirm('確定刪除這筆記錄？')) return;
            records.splice(i, 1);
            saveRecords();
            showRecords();
        }

        // 清除記錄
        function clearRecords() {
            if (confirm('確定清除所有記錄？')) {
                records = [];
                saveRecords();
                showRecords();
            }
        }

        // 匯出JSON（JSON已包含原始選項物件）
        function exportJSON() {
            if (records.length === 0) {
                alert('沒有資料可匯出');
                return;
            }
            const data = JSON.stringify(records, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = '✅ JSON已下載';
        }

        // 匯出CSV（已擴充：包含使用者當時所選項目文字）
        function exportCSV() {
            if (records.length === 0) {
                alert('沒有資料可匯出');
                return;
            }

            const headers = ['日期', '姓名', '病歷號', '年齡', '性別', '身高', '體重', 'A1分數', 'A2分數', 'A3分數', 'A4分數', 'B分數', 'C分數', 'D分數', '總分', '建議', '兩週體重變化', '體重變化程度', '最近攝食量比較', '目前攝食狀況', '腸胃症狀', '身體活動狀況', '疾病相關', '代謝壓力', '身體檢查'];

            const escapeCSV = (v) => '"' + String(v === undefined || v === null ? '' : v).replace(/"/g, '""') + '"';

            const csvData = [
                headers.join(','),
                ...records.map(r => [
                    r.date,
                    r.name,
                    r.number,
                    r.age,
                    r.gender === 'male' ? '男' : '女',
                    r.height,
                    r.currentWeight,
                    r.scores.a1,
                    r.scores.a2,
                    r.scores.a3,
                    r.scores.a4,
                    r.scores.b,
                    r.scores.c,
                    r.scores.d,
                    r.scores.total,
                    r.scores.advice,
                    selText(r.acuteWeight),
                    selText(r.subAcuteWeight),
                    selText(r.intakeComparison),
                    selText(r.currentIntake),
                    selText(r.symptoms),
                    selText(r.activityStatus),
                    selText(r.diseaseRelated),
                    selText(r.metabolicStress),
                    selText(r.physicalExam)
                ].map(escapeCSV).join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvData], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = '✅ CSV已下載';
        }

        // 匯出HTML（已擴充：列出使用者當時所選項目）
        function exportHTML() {
            if (records.length === 0) {
                alert('沒有資料可匯出');
                return;
            }

            const html = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>PG-SGA評估報告</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .record { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 8px; }
        .record h3 { background: #f5f5f5; padding: 10px; margin: -15px -15px 15px -15px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f5f5f5; }
    </style>
</head>
<body>
    <div class="header">
        <h1>PG-SGA 營養評估報告</h1>
        <p>生成時間: ${new Date().toLocaleString('zh-TW')}</p>
    </div>
    
    ${records.map((r, i) => `
        <div class="record">
            <h3>記錄 ${i + 1}: ${r.name} (${r.number}) - ${new Date(r.date).toLocaleDateString('zh-TW')}</h3>
            <table>
                <tr><th>項目</th><th>內容</th></tr>
                <tr><td>基本資料</td><td>年齡: ${r.age}歲, 性別: ${r.gender === 'male' ? '男' : '女'}</td></tr>
                <tr><td>身體測量</td><td>身高: ${r.height}cm, 體重: ${r.currentWeight}kg</td></tr>
                <tr><td>各項分數</td><td>A1:${r.scores.a1} A2:${r.scores.a2} A3:${r.scores.a3} A4:${r.scores.a4} B:${r.scores.b} C:${r.scores.c} D:${r.scores.d}</td></tr>
                <tr><td><strong>總分</strong></td><td><strong>${r.scores.total}</strong></td></tr>
                <tr><td>建議</td><td>${r.scores.advice}</td></tr>
                <tr><td>當時選擇</td><td>
                    <ul>
                        <li>兩週體重變化: ${selText(r.acuteWeight)}</li>
                        <li>體重變化程度: ${selText(r.subAcuteWeight)}</li>
                        <li>最近攝食量比較: ${selText(r.intakeComparison)}</li>
                        <li>目前攝食狀況: ${selText(r.currentIntake)}</li>
                        <li>腸胃症狀: ${selText(r.symptoms)}</li>
                        <li>身體活動狀況: ${selText(r.activityStatus)}</li>
                        <li>疾病相關: ${selText(r.diseaseRelated)}</li>
                        <li>代謝壓力: ${selText(r.metabolicStress)}</li>
                        <li>身體檢查: ${selText(r.physicalExam)}</li>
                    </ul>
                </td></tr>
            </table>
        </div>
    `).join('')}
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_report_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = '✅ HTML報告已下載';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // 綁定事件
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', updateScores);
            });

            // 表單提交
            document.getElementById('pgsga-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const data = collectData();
                if (!data.name || !data.number || !data.age) {
                    alert('請填寫必要資料');
                    return;
                }
                
                records.push(data);
                saveRecords();
                alert('已儲存！');
                switchTab('records');
            });
            
            updateScores();
        });
    </script>
</body>
</html>

